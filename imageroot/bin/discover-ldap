#!/usr/bin/env python3
import os
import agent
from agent.ldapproxy import Ldapproxy

ldap_domain = os.getenv("LDAP_DOMAIN", "")
agent.set_env("LDAP_DOMAIN", ldap_domain)

for var in [
    "LDAP_HOSTNAME", "LDAP_PORT", "LDAP_SEARCH_BIND_DN",
    "LDAP_SEARCH_BIND_PASSWORD", "LDAP_USER_BASE_DN",
    "LDAP_MEMBER_ATTRIBUTE", "LDAP_MEMBER_ATTRIBUTE_TYPE",
    "LDAP_GROUP_BASE_DN", "LDAP_USERNAME_ATTRIBUTE",
    "LDAP_USER_SEARCH_FILTER", "LDAP_GROUP_SEARCH_FILTER"
]:
    agent.unset_env(var)

if ldap_domain:
    odom = Ldapproxy().get_domain(ldap_domain)
    base_dn = odom["base_dn"]

    agent.set_env("LDAP_HOSTNAME", odom["host"])
    agent.set_env("LDAP_PORT", str(odom["port"]))
    agent.set_env("LDAP_SEARCH_BIND_DN", odom["bind_dn"])
    agent.set_env("LDAP_SEARCH_BIND_PASSWORD", odom["bind_password"])

    if odom["schema"] == "rfc2307":
        agent.set_env("LDAP_USER_BASE_DN",  f"ou=People,{base_dn}")
        agent.set_env("LDAP_GROUP_BASE_DN", f"ou=Groups,{base_dn}")
        agent.set_env("LDAP_MEMBER_ATTRIBUTE", "memberUid")
        agent.set_env("LDAP_MEMBER_ATTRIBUTE_TYPE", "uid")

    elif odom["schema"] == "ad":
        agent.set_env("LDAP_USER_BASE_DN",  f"cn=Users,{base_dn}")
        agent.set_env("LDAP_GROUP_BASE_DN", f"cn=Users,{base_dn}")
        agent.set_env("LDAP_USERNAME_ATTRIBUTE", "samaccountname")
        agent.set_env("LDAP_USER_SEARCH_FILTER",
                      "(&(objectClass=top)(objectClass=user)(objectClass=person)(objectClass=organizationalPerson))")
        agent.set_env("LDAP_GROUP_SEARCH_FILTER",
                      "(&(objectClass=top)(objectClass=group))")

agent.dump_env()